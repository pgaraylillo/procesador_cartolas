# test_labeling_system.py - Prueba el sistema de etiquetado mejorado
import sys
import os
from pathlib import Path
import pandas as pd
from datetime import datetime


def setup_test_environment():
    """Configura entorno de prueba"""
    current_dir = Path.cwd()
    if current_dir.name == 'app':
        project_root = current_dir.parent
        app_dir = current_dir
    elif (current_dir / 'app').exists():
        project_root = current_dir
        app_dir = current_dir / 'app'
    else:
        project_root = current_dir
        app_dir = current_dir / 'app'

    original_cwd = Path.cwd()
    os.chdir(project_root)
    sys.path.insert(0, str(app_dir))

    return project_root, app_dir, original_cwd


def create_test_data():
    """Crea datos de prueba para el etiquetado"""
    test_transactions = pd.DataFrame({
        'Fecha': ['2025-01-01', '2025-01-02', '2025-01-03', '2025-01-04', '2025-01-05'] * 4,
        'Descripci√≥n': [
            '0773820856 Transf a 4CDC BORDADOS',
            'PAGO EN LINEA PREVIRED',
            'Compra SUPERMERCADO LIDER',
            'Transf.Internet a TEXTIL JADUE',
            'COMISION MANTENCION CUENTA',
            'Abono Ventas GETNET',
            'COMBUSTIBLE COPEC ESTACION',
            'Transf a HERMANOS GARAY',
            'PAGO EN LINEA S.I.I.',
            'Compra TEXTIL CASSIS',
            '0146716709 Transf a Miguel Loza',
            'CARGO SERVICIO BANCARIO',
            'Compra RESTAURANT PIZZA',
            'TRANSFERENCIA EMPLEADO',
            'IMPUESTO MUNICIPAL',
            'COMPRA MATERIALES OFICINA',
            'GASTO COMBUSTIBLE AUTO',
            'PAGO CONTADOR TRIBUTARIO',
            'COMPRA INSUMOS BORDADO',
            'MANTENCION SISTEMA CONTABLE'
        ],
        'Monto': [-253470, -522252, -45000, -3972740, -15000, 163500, -35000, -200000,
                  -502049, -274082, -698292, -8900, -25000, -300000, -125000, -67000,
                  -42000, -180000, -89000, -95000],
        'ABONO/CARGO': ['CARGO'] * 19 + ['ABONO']
    })

    return test_transactions


def test_file_structure():
    """Verifica la estructura de archivos necesaria"""
    print("üìÅ VERIFICANDO ESTRUCTURA DE ARCHIVOS...")

    try:
        project_root, app_dir, original_cwd = setup_test_environment()

        # Verificar directorio labeling
        labeling_dir = app_dir / 'labeling'

        if not labeling_dir.exists():
            print(f"‚ùå FALTA DIRECTORIO: {labeling_dir}")
            print("üí° Necesitas crear: mkdir -p app/labeling")
            os.chdir(original_cwd)
            return False
        else:
            print(f"‚úÖ Directorio existe: {labeling_dir}")

        # Verificar archivos requeridos
        required_files = [
            labeling_dir / '__init__.py',
            labeling_dir / 'smart_labeling.py'
        ]

        missing_files = []
        for file_path in required_files:
            if file_path.exists() and file_path.stat().st_size > 10:  # Al menos 10 bytes
                print(f"‚úÖ {file_path}")
            else:
                if not file_path.exists():
                    print(f"‚ùå FALTA: {file_path}")
                else:
                    print(f"‚ùå VAC√çO: {file_path}")
                missing_files.append(file_path)

        os.chdir(original_cwd)

        if missing_files:
            print(f"\nüí° ARCHIVOS FALTANTES O VAC√çOS:")
            for file_path in missing_files:
                print(f"   üìù Crear/completar: {file_path}")
            return False
        else:
            print(f"‚úÖ Todos los archivos necesarios est√°n presentes")
            return True

    except Exception as e:
        print(f"‚ùå Error verificando estructura de archivos: {e}")
        try:
            os.chdir(original_cwd)
        except:
            pass
        return False


def test_smart_labeling_system():
    """Prueba el SmartLabelingSystem"""
    print("\nüß™ PROBANDO SMART LABELING SYSTEM...")

    try:
        project_root, app_dir, original_cwd = setup_test_environment()
        print(f"‚úÖ Entorno configurado: {project_root}")

        # Verificar DataStore
        try:
            from storage.datastore import DataStore
            ds = DataStore()
            if not ds.is_ready():
                print("‚ö†Ô∏è DataStore no est√° completamente listo, pero continuamos")
            print("‚úÖ DataStore inicializado")
        except Exception as e:
            print(f"‚ùå Error con DataStore: {e}")
            os.chdir(original_cwd)
            return False

        # Crear datos de prueba
        test_data = create_test_data()
        gastos_test = test_data[test_data['Monto'] < 0].copy()
        print(f"‚úÖ Datos de prueba creados: {len(gastos_test)} gastos")

        # Probar SmartLabelingSystem
        try:
            from labeling.smart_labeling import SmartLabelingSystem
            print("‚úÖ SmartLabelingSystem importado correctamente")
        except ImportError as e:
            print(f"‚ùå No se puede importar SmartLabelingSystem: {e}")
            print("üí° Esto es normal si a√∫n no has creado app/labeling/smart_labeling.py")
            os.chdir(original_cwd)
            return False
        except Exception as e:
            print(f"‚ùå Error inesperado importando SmartLabelingSystem: {e}")
            os.chdir(original_cwd)
            return False

        # Crear instancia del sistema
        labeling_system = SmartLabelingSystem(ds)
        print("‚úÖ SmartLabelingSystem creado")

        # Probar creaci√≥n de claves de transacci√≥n
        print(f"üîß Probando creaci√≥n de claves...")
        test_row = gastos_test.iloc[0]
        transaction_key = labeling_system.create_transaction_key(test_row)
        print(f"‚úÖ Clave creada: {transaction_key}")

        # Probar carga de etiquetas existentes
        print(f"üîß Probando carga de etiquetas existentes...")
        existing_labels = labeling_system.load_existing_labels(gastos_test)
        print(f"‚úÖ Etiquetas existentes cargadas: {len(existing_labels)}")

        # Probar guardado de etiqueta individual
        print(f"üîß Probando guardado de etiqueta...")
        test_transaction = gastos_test.iloc[0]
        test_key = labeling_system.create_transaction_key(test_transaction)

        try:
            labeling_system.save_label_immediately(test_transaction, 'bordados', test_key)
            print("‚úÖ Etiqueta guardada exitosamente")
        except Exception as e:
            print(f"‚ö†Ô∏è Error guardando etiqueta: {str(e)[:100]}...")

        # Probar estad√≠sticas
        print(f"üîß Probando estad√≠sticas...")
        stats = labeling_system.get_labeling_statistics()

        if 'error' not in stats:
            print("‚úÖ Estad√≠sticas obtenidas:")
            print(f"   üìä Total etiquetadas: {stats.get('total_labeled', 0)}")
            print(f"   üìÇ Categor√≠as usadas: {stats.get('categories_used', 0)}")
            print(f"   üèÜ M√°s com√∫n: {stats.get('most_common_category', 'N/A')}")
        else:
            print(f"‚ùå Error en estad√≠sticas: {stats['error']}")

        os.chdir(original_cwd)
        print(f"üéâ ¬°SMART LABELING SYSTEM FUNCIONA CORRECTAMENTE!")
        return True

    except Exception as e:
        print(f"‚ùå Error general probando SmartLabelingSystem: {e}")
        try:
            os.chdir(original_cwd)
        except:
            pass
        return False


def test_integration_functions():
    """Prueba las funciones de integraci√≥n"""
    print(f"\nüîß PROBANDO FUNCIONES DE INTEGRACI√ìN...")

    try:
        project_root, app_dir, original_cwd = setup_test_environment()

        try:
            from labeling.smart_labeling import show_improved_labeling_page
            print("‚úÖ show_improved_labeling_page importada correctamente")

            if callable(show_improved_labeling_page):
                print("‚úÖ show_improved_labeling_page es una funci√≥n v√°lida")
                os.chdir(original_cwd)
                return True
            else:
                print("‚ùå show_improved_labeling_page no es callable")
                os.chdir(original_cwd)
                return False

        except ImportError as e:
            print(f"‚ùå No se puede importar funciones de integraci√≥n: {e}")
            print("üí° Esto es normal si a√∫n no has creado los archivos del sistema de etiquetado")
            os.chdir(original_cwd)
            return False
        except Exception as e:
            print(f"‚ùå Error inesperado probando funciones de integraci√≥n: {e}")
            os.chdir(original_cwd)
            return False

    except Exception as e:
        print(f"‚ùå Error en setup de test de integraci√≥n: {e}")
        return False


def show_success_instructions():
    """Muestra instrucciones cuando todo funciona"""
    print(f"\nüéØ PR√ìXIMOS PASOS:")
    print("1. Integrar en main.py:")
    print("   - Reemplaza la funci√≥n page_labeling() actual")
    print("   - Agrega las importaciones necesarias")
    print()
    print("2. Probar en Streamlit:")
    print("   streamlit run app/main.py")
    print()
    print("3. El nuevo sistema incluye:")
    print("   ‚úÖ Paginaci√≥n (10, 25, 50, 100 por p√°gina)")
    print("   ‚úÖ Auto-guardado de etiquetas")
    print("   ‚úÖ Prevenci√≥n de duplicados")
    print("   ‚úÖ Persistencia entre actualizaciones")
    print("   ‚úÖ Progreso visual")
    print("   ‚úÖ Estad√≠sticas y res√∫menes")


def show_partial_success_instructions():
    """Muestra instrucciones cuando hay √©xito parcial"""
    print(f"\nüîß PARA COMPLETAR LA CONFIGURACI√ìN:")
    print("1. Revisa los errores arriba")
    print("2. Verifica que copiaste correctamente el c√≥digo de los artifacts")
    print("3. Aseg√∫rate de que el DataStore funcione:")
    print("   python test_datastore_fix.py")
    print("4. Vuelve a ejecutar este test")


def show_setup_instructions():
    """Muestra instrucciones de configuraci√≥n inicial"""
    print(f"\nüîß PARA CONFIGURAR EL SISTEMA:")
    print("1. Crear directorio:")
    print("   mkdir -p app/labeling")
    print()
    print("2. Crear archivos desde los artifacts:")
    print("   - app/labeling/__init__.py")
    print("   - app/labeling/smart_labeling.py")
    print()
    print("3. Volver a ejecutar este test:")
    print("   python test_labeling_system.py")


def main():
    """Ejecuta todas las pruebas del sistema de etiquetado"""
    print("üöÄ PRUEBA COMPLETA DEL SISTEMA DE ETIQUETADO MEJORADO")
    print("=" * 70)

    # Verificaci√≥n previa de requisitos b√°sicos
    print("üîç VERIFICANDO REQUISITOS B√ÅSICOS...")
    try:
        project_root, app_dir, original_cwd = setup_test_environment()
        print(f"‚úÖ Entorno configurado: {project_root}")

        # Verificar que DataStore funciona
        from storage.datastore import DataStore
        ds = DataStore()
        if ds.is_ready():
            print("‚úÖ DataStore funcionando correctamente")
        else:
            print("‚ö†Ô∏è DataStore no est√° completamente listo, pero continuamos")

        os.chdir(original_cwd)

    except Exception as e:
        print(f"‚ùå ERROR CR√çTICO: DataStore no funciona: {e}")
        print("üí° Ejecuta primero: python test_datastore_fix.py")
        return False

    # Ejecutar pruebas
    test_results = {}

    # Test 1: Estructura de archivos
    try:
        test_results['file_structure'] = test_file_structure()
    except Exception as e:
        print(f"‚ùå Error en test de estructura: {e}")
        test_results['file_structure'] = False

    # Test 2: Sistema de etiquetado (solo si la estructura est√° bien)
    if test_results.get('file_structure', False):
        try:
            test_results['smart_labeling_system'] = test_smart_labeling_system()
        except Exception as e:
            print(f"‚ùå Error en test de SmartLabelingSystem: {e}")
            test_results['smart_labeling_system'] = False
    else:
        print("‚ö†Ô∏è Saltando test de SmartLabelingSystem (falta estructura de archivos)")
        test_results['smart_labeling_system'] = False

    # Test 3: Funciones de integraci√≥n (solo si el sistema funciona)
    if test_results.get('smart_labeling_system', False):
        try:
            test_results['integration_functions'] = test_integration_functions()
        except Exception as e:
            print(f"‚ùå Error en test de integraci√≥n: {e}")
            test_results['integration_functions'] = False
    else:
        print("‚ö†Ô∏è Saltando test de integraci√≥n (SmartLabelingSystem no funciona)")
        test_results['integration_functions'] = False

    # Resumen
    print(f"\n" + "=" * 70)
    print("üìã RESUMEN DE PRUEBAS:")

    for test_name, result in test_results.items():
        status = "‚úÖ √âXITO" if result else "‚ùå FALLO"
        print(f"   {status}: {test_name}")

    passed_tests = sum(test_results.values())
    total_tests = len(test_results)

    print(f"\nüéØ RESULTADO: {passed_tests}/{total_tests} pruebas pasaron")

    # Evaluaci√≥n y recomendaciones
    if test_results.get('file_structure', False):
        if passed_tests >= 2:
            print("\nüéâ ¬°SISTEMA DE ETIQUETADO LISTO!")
            print("‚úÖ Puedes integrar con Streamlit")
            show_success_instructions()
        else:
            print("\n‚ö†Ô∏è SISTEMA PARCIALMENTE LISTO")
            print("‚úÖ Estructura de archivos correcta")
            print("‚ùå Hay errores en la implementaci√≥n")
            show_partial_success_instructions()
    else:
        print(f"\nüí• SISTEMA NO LISTO")
        print("‚ùå Faltan archivos cr√≠ticos")
        show_setup_instructions()

    return passed_tests >= 1


if __name__ == "__main__":
    try:
        success = main()
        print(f"\n{'=' * 70}")
        if success:
            print("üéä ¬°PRUEBA EXITOSA! El sistema de etiquetado est√° listo.")
        else:
            print("üíî PRUEBA FALL√ì. Revisa los errores y sigue las instrucciones.")

        sys.exit(0 if success else 1)

    except Exception as e:
        print(f"\nüí• ERROR CR√çTICO EJECUTANDO PRUEBAS: {e}")
        import traceback

        traceback.print_exc()
        sys.exit(1)