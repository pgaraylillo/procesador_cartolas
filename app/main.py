# app/main.py - Aplicaci√≥n Streamlit completa con todos los sistemas integrados
from __future__ import annotations
import streamlit as st
import pandas as pd
from pathlib import Path
import traceback
from datetime import datetime

# Import del sistema de componentes robusto
from components.component_manager import (
    get_component,
    ComponentStatus,
    initialize_session_state,
    show_component_status_sidebar,
    handle_component_error
)

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="Santander Finance App",
    page_icon="üìä",
    layout="wide",
    initial_sidebar_state="expanded"
)


def main_header():
    """Header principal de la aplicaci√≥n"""
    col1, col2, col3 = st.columns([2, 3, 1])

    with col1:
        st.title("üìä Santander Finance App")

    with col2:
        st.markdown("### Sistema de an√°lisis financiero y gesti√≥n de contactos")

    with col3:
        if st.button("üîÑ Actualizar", help="Recargar sistema"):
            st.cache_data.clear()
            st.rerun()


def sidebar_navigation():
    """Navegaci√≥n principal en sidebar mejorada"""
    st.sidebar.title("üß≠ Navegaci√≥n")

    pages = {
        "üìÅ Cargar Cartola": "upload",
        "üè∑Ô∏è Etiquetar Gastos": "labeling",
        "ü§ñ Entrenar IA": "training",
        "üìä Dashboard": "dashboard",
        "üë• Gesti√≥n Contactos": "contacts",  # üÜï NUEVA P√ÅGINA
        "üîÑ Integraci√≥n KAME": "kame",
        "‚öôÔ∏è Configuraci√≥n": "settings"
    }

    selected_page = st.sidebar.radio("Seleccionar p√°gina:", list(pages.keys()))

    # Estado del sistema - usando el nuevo sistema
    show_component_status_sidebar()

    # Informaci√≥n del estado de datos
    st.sidebar.markdown("---")
    st.sidebar.markdown("### üìà Estado de datos")

    try:
        # Obtener DataStore con el nuevo sistema
        datastore, datastore_status = get_component('datastore')

        if datastore_status == ComponentStatus.READY and datastore:
            try:
                labeled_data = datastore.load_labeled()
                if not labeled_data.empty:
                    st.sidebar.success(f"‚úÖ {len(labeled_data)} transacciones etiquetadas")
                    categories = labeled_data['category'].nunique() if 'category' in labeled_data.columns else 0
                    st.sidebar.info(f"üìã {categories} categor√≠as diferentes")
                else:
                    st.sidebar.warning("‚ö†Ô∏è Sin datos etiquetados")

                # Mostrar informaci√≥n de contactos
                try:
                    from contacts.contacts_manager import ContactsManager
                    contacts_manager = ContactsManager(datastore)
                    contacts_summary = contacts_manager.get_contacts_summary()

                    if 'error' not in contacts_summary:
                        total_contacts = contacts_summary.get('total_contacts', 0)
                        if total_contacts > 0:
                            st.sidebar.info(f"üë• {total_contacts} contactos registrados")
                        else:
                            st.sidebar.info("üë• Sin contactos")
                except ImportError:
                    st.sidebar.info("üë• Sistema de contactos no disponible")
                except Exception as e:
                    st.sidebar.warning(f"üë• Error contactos: {str(e)[:30]}...")

            except Exception as e:
                st.sidebar.error(f"‚ùå Error cargando datos: {str(e)[:50]}...")
        else:
            st.sidebar.error("‚ùå DataStore no disponible")

    except Exception as e:
        st.sidebar.error(f"‚ùå Error del sistema: {str(e)[:50]}...")

    return pages[selected_page]


def safe_component_operation(component_name: str, operation_name: str):
    """Decorator para operaciones seguras con componentes"""

    def decorator(func):
        def wrapper(*args, **kwargs):
            try:
                component, status = get_component(component_name)

                if status != ComponentStatus.READY or not component:
                    st.error(f"‚ùå {component_name.title()} no est√° disponible")
                    st.info(f"Estado: {status.value}")

                    if st.button(f"üîÑ Reintentar inicializar {component_name}"):
                        from components.component_manager import get_component_manager
                        manager = get_component_manager()
                        manager.force_reinitialize(component_name)
                        st.rerun()
                    return None

                return func(component, *args, **kwargs)

            except Exception as e:
                st.error(f"‚ùå Error en {operation_name}: {str(e)}")
                handle_component_error(component_name, e)
                return None

        return wrapper

    return decorator


@safe_component_operation('parser', 'procesamiento de cartola')
def page_upload(parser):
    """P√°gina de carga de cartolas con manejo robusto"""
    st.header("üìÅ Cargar Cartola Santander")
    st.markdown("Sube tu archivo Excel (.xlsx) de cartola bancaria para procesarlo.")

    # File uploader
    uploaded_file = st.file_uploader(
        "Seleccionar archivo de cartola",
        type=['xlsx', 'xls'],
        help="Solo archivos Excel de cartolas Santander"
    )

    if uploaded_file is not None:
        try:
            with st.spinner("Procesando cartola..."):
                # Save uploaded file temporarily
                temp_path = Path(f"uploads/{uploaded_file.name}")
                temp_path.parent.mkdir(exist_ok=True)

                with open(temp_path, "wb") as f:
                    f.write(uploaded_file.getbuffer())

                # Validate file b√°sico
                size_mb = temp_path.stat().st_size / (1024 * 1024)

                col1, col2 = st.columns([2, 1])

                with col2:
                    st.markdown("### üìä Info del archivo")
                    st.info(f"**Tama√±o:** {size_mb:.1f} MB")
                    st.info(f"**Formato:** {temp_path.suffix}")

                with col1:
                    if size_mb > 50:
                        st.error("‚ùå Archivo muy grande (m√°x 50MB)")
                        return

                    # Read and parse file con manejo de errores
                    try:
                        df_raw = pd.read_excel(temp_path)
                        st.success(f"‚úÖ Archivo le√≠do: {len(df_raw)} filas, {len(df_raw.columns)} columnas")
                    except Exception as e:
                        st.error(f"‚ùå Error leyendo archivo: {str(e)}")
                        return

                    # Parse with Santander parser
                    try:
                        df_parsed = parser.parse(df_raw)
                        st.success(f"üéØ Procesamiento completado: {len(df_parsed)} transacciones v√°lidas")
                    except Exception as e:
                        st.error(f"‚ùå Error procesando cartola: {str(e)}")
                        st.info("üí° Verifica que sea una cartola v√°lida de Santander")
                        return

                # Store in session state
                st.session_state.current_data = df_parsed

                # Show preview con formato mejorado
                st.markdown("### üëÄ Vista previa de datos procesados")
                show_transaction_preview(df_parsed)

                # Clean up temp file
                temp_path.unlink(missing_ok=True)

        except Exception as e:
            st.error(f"‚ùå Error general procesando archivo: {str(e)}")
            with st.expander("üîç Detalles del error"):
                st.code(traceback.format_exc())


def show_transaction_preview(df_parsed):
    """Muestra preview de transacciones con mejora autom√°tica de descripciones"""
    if df_parsed.empty:
        st.warning("‚ö†Ô∏è No hay transacciones para mostrar")
        return

    try:
        # NUEVO: Opci√≥n para mejorar descripciones autom√°ticamente
        col_enhance1, col_enhance2 = st.columns([3, 1])

        with col_enhance1:
            improve_descriptions = st.checkbox(
                "üîÑ Mejorar descripciones con nombres de contactos",
                value=True,
                help="Reemplaza RUTs en las descripciones por nombres de contactos"
            )

        with col_enhance2:
            if st.button("üë• Gestionar Contactos"):
                st.session_state.page = "contacts"
                st.rerun()

        # Aplicar mejoras si est√° habilitado
        df_display = df_parsed.copy()

        if improve_descriptions:
            try:
                # Obtener el datastore desde los componentes
                datastore, status = get_component('datastore')

                if status == ComponentStatus.READY and datastore:
                    from contacts.contacts_manager import ContactsManager
                    contacts_manager = ContactsManager(datastore)

                    with st.spinner("üîÑ Mejorando descripciones con nombres de contactos..."):
                        df_display = contacts_manager.enhance_transaction_descriptions(df_display)

                        # Contar cu√°ntas descripciones se mejoraron
                        if 'Descripci√≥n_Original' in df_display.columns:
                            improved_count = sum(
                                1 for orig, new in zip(df_parsed['Descripci√≥n'], df_display['Descripci√≥n'])
                                if orig != new
                            )
                            if improved_count > 0:
                                st.success(f"‚ú® {improved_count} descripciones mejoradas con nombres de contactos")

            except Exception as e:
                st.warning(f"‚ö†Ô∏è No se pudieron mejorar descripciones: {e}")
                df_display = df_parsed.copy()

        # M√©tricas principales
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            st.metric("Total transacciones", len(df_parsed))

        with col2:
            gastos = df_parsed[df_parsed['Monto'] < 0] if 'Monto' in df_parsed.columns else pd.DataFrame()
            st.metric("Gastos (CARGO)", len(gastos))

        with col3:
            ingresos = df_parsed[df_parsed['Monto'] > 0] if 'Monto' in df_parsed.columns else pd.DataFrame()
            st.metric("Ingresos (ABONO)", len(ingresos))

        with col4:
            if 'Monto' in df_parsed.columns:
                balance = df_parsed['Monto'].sum()
                balance_fmt = f"${balance:,.0f}".replace(",",
                                                         ".") if balance >= 0 else f"-${abs(balance):,.0f}".replace(",",
                                                                                                                    ".")
                st.metric("Balance Neto", balance_fmt)

        # Formatear montos para display
        if 'Monto' in df_display.columns:
            df_display['Monto_Formateado'] = df_display['Monto'].apply(
                lambda x: f"${x:,.0f}".replace(",", ".") if x >= 0
                else f"-${abs(x):,.0f}".replace(",", ".")
            )

        # Preparar columnas para mostrar
        display_columns = ['Fecha', 'Descripci√≥n', 'Monto_Formateado', 'ABONO/CARGO']
        if 'Descripci√≥n_Original' in df_display.columns:
            display_columns.insert(2, 'Descripci√≥n_Original')

        # Preparar DataFrame para mostrar
        df_show = df_display.copy()
        if 'Monto_Formateado' in df_show.columns:
            df_show = df_show.rename(columns={'Monto_Formateado': 'Monto'})

        # Mostrar solo las columnas necesarias
        final_columns = ['Fecha', 'Descripci√≥n', 'Monto', 'ABONO/CARGO']
        if 'Descripci√≥n_Original' in df_show.columns:
            final_columns.insert(2, 'Descripci√≥n_Original')

        df_show = df_show[[col for col in final_columns if col in df_show.columns]]

        st.dataframe(df_show, use_container_width=True, height=400)

        # Action buttons
        col1, col2, col3 = st.columns(3)

        with col1:
            if st.button("‚û°Ô∏è Ir a Etiquetar", type="primary"):
                # Guardar datos mejorados en session_state
                st.session_state.current_data = df_display
                st.session_state.page = "labeling"
                st.rerun()

        with col2:
            if st.button("üíæ Guardar datos"):
                save_current_data()

        with col3:
            if st.button("üì• Descargar CSV"):
                # Descargar datos con descripciones mejoradas
                csv = df_display.to_csv(index=False)
                st.download_button(
                    label="‚¨áÔ∏è Descargar",
                    data=csv,
                    file_name=f"cartola_procesada_{datetime.now().strftime('%Y%m%d_%H%M')}.csv",
                    mime="text/csv"
                )

    except Exception as e:
        st.error(f"‚ùå Error mostrando preview: {str(e)}")


@safe_component_operation('datastore', 'guardado de datos')
def save_current_data(datastore):
    """Guarda datos actuales de manera segura"""
    if st.session_state.current_data is None:
        st.warning("‚ö†Ô∏è No hay datos para guardar")
        return

    try:
        # Aqu√≠ podr√≠as implementar la l√≥gica de guardado adicional
        st.success("‚úÖ Datos guardados exitosamente")
    except Exception as e:
        st.error(f"‚ùå Error guardando datos: {str(e)}")


@safe_component_operation('datastore', 'etiquetado de transacciones')
def page_labeling(datastore):
    """P√°gina de etiquetado con sistema mejorado"""
    try:
        # Importar el nuevo sistema de etiquetado
        from labeling.smart_labeling import show_improved_labeling_page

        # Usar el sistema mejorado
        show_improved_labeling_page(datastore, st.session_state.current_data)

    except ImportError:
        # Fallback al sistema anterior si no est√° disponible el nuevo
        st.error("‚ùå Sistema de etiquetado mejorado no disponible")
        st.info("üîß Usando sistema b√°sico como fallback")
        page_labeling_basic(datastore)
    except Exception as e:
        st.error(f"‚ùå Error en sistema de etiquetado: {e}")
        handle_component_error('datastore', e)


def page_labeling_basic(datastore):
    """Sistema de etiquetado b√°sico como fallback"""
    st.header("üè∑Ô∏è Etiquetar Gastos - Sistema B√°sico")

    if st.session_state.current_data is None:
        st.warning("‚ö†Ô∏è Primero debes cargar una cartola")
        if st.button("üìÅ Ir a Cargar"):
            st.session_state.page = "upload"
            st.rerun()
        return

    df = st.session_state.current_data
    gastos = df[df['Monto'] < 0].copy() if 'Monto' in df.columns else pd.DataFrame()

    if gastos.empty:
        st.info("‚ÑπÔ∏è No hay gastos para etiquetar en la cartola actual")
        return

    st.markdown(f"### Etiquetando {len(gastos)} transacciones de gasto")

    try:
        categorias = datastore.get_categories()
        show_basic_labeling_interface(gastos, categorias, datastore)
    except Exception as e:
        st.error(f"‚ùå Error en etiquetado b√°sico: {e}")


def show_basic_labeling_interface(gastos, categorias, datastore):
    """Interfaz b√°sica de etiquetado (versi√≥n anterior simplificada)"""
    if 'Categor√≠a' not in gastos.columns:
        gastos['Categor√≠a'] = ""

    num_to_show = min(20, len(gastos))
    st.info(f"Mostrando las primeras {num_to_show} de {len(gastos)} transacciones")

    with st.container():
        for idx, (_, row) in enumerate(gastos.head(num_to_show).iterrows()):
            col1, col2, col3, col4 = st.columns([2, 3, 2, 1])

            with col1:
                st.text(str(row.get('Fecha', '')))

            with col2:
                desc = str(row.get('Descripci√≥n', ''))
                display_desc = desc[:50] + "..." if len(desc) > 50 else desc
                st.text(display_desc)

            with col3:
                amount = row.get('Monto', 0)
                monto_fmt = f"${abs(amount):,.0f}".replace(",", ".")
                st.text(monto_fmt)

            with col4:
                selected_category = st.selectbox(
                    "Categor√≠a",
                    [""] + categorias,
                    key=f"basic_cat_{idx}_{row.name}",
                    label_visibility="collapsed"
                )

                if selected_category:
                    gastos.loc[row.name, 'Categor√≠a'] = selected_category

    if st.button("üíæ Guardar etiquetas b√°sicas"):
        save_labels_basic(gastos, datastore)


def save_labels_basic(gastos, datastore):
    """Guardado b√°sico de etiquetas"""
    try:
        etiquetados = gastos[gastos['Categor√≠a'] != ""]
        if not etiquetados.empty:
            df_to_save = etiquetados[['Fecha', 'Descripci√≥n', 'Monto', 'Categor√≠a']].copy()
            df_to_save = df_to_save.rename(columns={'Categor√≠a': 'category'})

            datastore.save_labeled(df_to_save)
            st.success(f"‚úÖ {len(etiquetados)} transacciones etiquetadas guardadas")
        else:
            st.warning("‚ö†Ô∏è No hay etiquetas para guardar")
    except Exception as e:
        st.error(f"‚ùå Error guardando etiquetas b√°sicas: {e}")


@safe_component_operation('datastore', 'entrenamiento de IA')
def page_training(datastore):
    """P√°gina de entrenamiento con manejo robusto"""
    st.header("ü§ñ Entrenar IA")
    st.markdown("Entrena el clasificador autom√°tico con las transacciones etiquetadas.")

    try:
        labeled_data = datastore.load_labeled()

        if labeled_data.empty:
            st.warning("‚ö†Ô∏è No hay datos etiquetados disponibles")
            st.markdown("Primero debes etiquetar algunas transacciones:")
            if st.button("üè∑Ô∏è Ir a Etiquetar"):
                st.session_state.page = "labeling"
                st.rerun()
            return

        st.success(f"‚úÖ {len(labeled_data)} transacciones etiquetadas encontradas")

        # Mostrar estad√≠sticas
        show_training_statistics(labeled_data)

        # Bot√≥n de entrenamiento
        if st.button("üöÄ Entrenar Modelo", type="primary"):
            train_classifier(labeled_data)

    except Exception as e:
        st.error(f"‚ùå Error en p√°gina de entrenamiento: {str(e)}")
        handle_component_error('datastore', e)


def show_training_statistics(labeled_data):
    """Muestra estad√≠sticas para entrenamiento"""
    if 'category' not in labeled_data.columns:
        st.error("‚ùå No se encontr√≥ columna 'category' en los datos")
        return

    category_stats = labeled_data['category'].value_counts()

    col1, col2 = st.columns(2)

    with col1:
        st.markdown("### üìä Distribuci√≥n por categor√≠a")
        st.bar_chart(category_stats)

    with col2:
        st.markdown("### üìà Estad√≠sticas")
        st.dataframe(category_stats.reset_index())

    # Verificar calidad de datos
    min_samples = 3
    insufficient_categories = category_stats[category_stats < min_samples]

    if not insufficient_categories.empty:
        st.warning(f"‚ö†Ô∏è Algunas categor√≠as tienen menos de {min_samples} ejemplos:")
        st.write(insufficient_categories.index.tolist())
        st.info("üí° Se recomienda tener al menos 3 ejemplos por categor√≠a")


@safe_component_operation('classifier', 'entrenamiento de modelo')
def train_classifier(labeled_data, classifier):
    """Entrena el clasificador con manejo robusto"""
    with st.spinner("Entrenando clasificador..."):
        try:
            classifier.fit(labeled_data, label_col='category')
            st.success("‚úÖ Modelo entrenado exitosamente!")

            # Mostrar m√©tricas si est√°n disponibles
            try:
                report = classifier.report(labeled_data, labeled_data['category'])
                st.text("üìä Reporte de clasificaci√≥n:")
                st.code(report)
            except Exception as e:
                st.warning(f"‚ö†Ô∏è No se pudo generar reporte: {str(e)}")

        except Exception as e:
            st.error(f"‚ùå Error entrenando modelo: {str(e)}")


def page_dashboard():
    """Dashboard simplificado y robusto"""
    st.header("üìä Dashboard Financiero")

    if st.session_state.current_data is None:
        st.warning("‚ö†Ô∏è No hay datos cargados")
        if st.button("üìÅ Cargar datos"):
            st.session_state.page = "upload"
            st.rerun()
        return

    df = st.session_state.current_data

    try:
        show_financial_dashboard(df)
    except Exception as e:
        st.error(f"‚ùå Error en dashboard: {str(e)}")
        with st.expander("üîç Detalles del error"):
            st.code(str(e))


def show_financial_dashboard(df):
    """Muestra dashboard financiero de manera robusta"""
    # Verificar columnas necesarias
    required_cols = ['Monto', 'Fecha', 'Descripci√≥n']
    missing_cols = [col for col in required_cols if col not in df.columns]

    if missing_cols:
        st.error(f"‚ùå Faltan columnas requeridas: {missing_cols}")
        return

    # M√©tricas principales
    col1, col2, col3, col4 = st.columns(4)

    gastos = df[df['Monto'] < 0]
    ingresos = df[df['Monto'] > 0]

    with col1:
        st.metric("Total Transacciones", len(df))

    with col2:
        total_gastos_monto = abs(gastos['Monto'].sum())
        gastos_fmt = f"${total_gastos_monto:,.0f}".replace(",", ".")
        st.metric("Total Gastos", gastos_fmt)

    with col3:
        total_ingresos_monto = ingresos['Monto'].sum()
        ingresos_fmt = f"${total_ingresos_monto:,.0f}".replace(",", ".")
        st.metric("Total Ingresos", ingresos_fmt)

    with col4:
        balance = df['Monto'].sum()
        balance_fmt = f"${balance:,.0f}".replace(",", ".") if balance >= 0 else f"-${abs(balance):,.0f}".replace(",",
                                                                                                                 ".")
        st.metric("Balance Neto", balance_fmt)

    # Gr√°ficos b√°sicos
    col1, col2 = st.columns(2)

    with col1:
        st.markdown("### üí∏ Top 10 Gastos")
        if not gastos.empty:
            top_gastos = gastos.nlargest(10, 'Monto', keep='all')[['Descripci√≥n', 'Monto']]
            top_gastos['Monto_Abs'] = abs(top_gastos['Monto'])

            # Truncar descripciones largas
            top_gastos['Descripci√≥n_Short'] = top_gastos['Descripci√≥n'].apply(
                lambda x: x[:30] + "..." if len(str(x)) > 30 else str(x)
            )

            st.bar_chart(top_gastos.set_index('Descripci√≥n_Short')['Monto_Abs'])
        else:
            st.info("Sin gastos para mostrar")

    with col2:
        st.markdown("### üìà Transacciones por d√≠a")
        if not df.empty:
            try:
                df_chart = df.copy()
                df_chart['Fecha'] = pd.to_datetime(df_chart['Fecha'], errors='coerce')
                df_chart = df_chart.dropna(subset=['Fecha'])

                if not df_chart.empty:
                    daily_summary = df_chart.groupby(df_chart['Fecha'].dt.date)['Monto'].sum().reset_index()
                    daily_summary = daily_summary.set_index('Fecha')
                    st.line_chart(daily_summary)
                else:
                    st.info("No hay fechas v√°lidas para el gr√°fico")
            except Exception as e:
                st.error(f"Error creando gr√°fico temporal: {str(e)}")

    # Tabla de transacciones recientes
    st.markdown("### üìã Transacciones recientes")

    df_display = df.head(20).copy()
    if 'Monto' in df_display.columns:
        df_display['Monto_Formateado'] = df_display['Monto'].apply(
            lambda x: f"${x:,.0f}".replace(",", ".") if x >= 0
            else f"-${abs(x):,.0f}".replace(",", ".")
        )

        display_cols = ['Fecha', 'Descripci√≥n', 'Monto_Formateado']
        if 'ABONO/CARGO' in df_display.columns:
            display_cols.append('ABONO/CARGO')

        df_show = df_display[display_cols].rename(columns={'Monto_Formateado': 'Monto'})
        st.dataframe(df_show, use_container_width=True)


@safe_component_operation('datastore', 'gesti√≥n de contactos')
def page_contacts(datastore):
    """P√°gina de gesti√≥n de contactos con sistema mejorado"""

    # Intentar usar el sistema mejorado primero
    try:
        from contacts.enhanced_contacts_interface import show_transfer_summary_page
        show_transfer_summary_page(datastore)
        return

    except ImportError:
        st.warning("‚ö†Ô∏è Sistema mejorado no disponible, usando sistema b√°sico")

    # Fallback al sistema original
    try:
        from contacts.contacts_manager import show_contacts_management_page
        show_contacts_management_page(datastore)

    except ImportError:
        st.error("‚ùå Sistema de contactos no disponible")
        st.info("üîß M√≥dulo de contactos no instalado correctamente")

        # Mostrar instrucciones de instalaci√≥n
        with st.expander("üìù Instrucciones de instalaci√≥n"):
            st.markdown("""
            **Para habilitar el sistema de contactos mejorado:**

            1. Crear directorio:
            ```bash
            mkdir -p app/contacts
            ```

            2. Crear los archivos necesarios:
            - `app/contacts/__init__.py`
            - `app/contacts/contacts_manager.py`
            - `app/contacts/transfer_summary_detector.py`
            - `app/contacts/enhanced_contacts_interface.py`

            3. Ejecutar prueba del sistema:
            ```bash
            python test_transfer_detector.py
            ```
            """)

    except Exception as e:
        st.error(f"‚ùå Error en gesti√≥n de contactos: {e}")
        handle_component_error('datastore', e)


# 2. MEJORAR LA FUNCI√ìN show_transaction_preview PARA USAR EL NUEVO SISTEMA
def show_transaction_preview(df_parsed):
    """Muestra preview de transacciones con mejora autom√°tica de descripciones"""
    if df_parsed.empty:
        st.warning("‚ö†Ô∏è No hay transacciones para mostrar")
        return

    try:
        # NUEVO: Opci√≥n para mejorar descripciones autom√°ticamente
        col_enhance1, col_enhance2 = st.columns([3, 1])

        with col_enhance1:
            improve_descriptions = st.checkbox(
                "üîÑ Mejorar descripciones con nombres de contactos",
                value=True,
                help="Reemplaza RUTs en las descripciones por nombres de contactos"
            )

        with col_enhance2:
            if st.button("üë• Gestionar Contactos"):
                st.session_state.page = "contacts"
                st.rerun()

        # Aplicar mejoras si est√° habilitado
        df_display = df_parsed.copy()

        if improve_descriptions:
            try:
                # Obtener el datastore desde los componentes
                datastore, status = get_component('datastore')

                if status == ComponentStatus.READY and datastore:
                    # USAR EL SISTEMA MEJORADO
                    try:
                        from contacts.transfer_summary_detector import ImprovedContactsManager
                        enhanced_manager = ImprovedContactsManager(datastore)

                        with st.spinner("‚ú® Mejorando descripciones con sistema avanzado..."):
                            df_display = enhanced_manager.enhance_transaction_descriptions(df_display)

                    except ImportError:
                        # Fallback al sistema original
                        from contacts.contacts_manager import ContactsManager
                        contacts_manager = ContactsManager(datastore)

                        with st.spinner("üîÑ Mejorando descripciones..."):
                            df_display = contacts_manager.enhance_transaction_descriptions(df_display)

                    # Contar cu√°ntas descripciones se mejoraron
                    if 'Descripci√≥n_Original' in df_display.columns:
                        improved_count = sum(
                            1 for orig, new in zip(df_parsed['Descripci√≥n'], df_display['Descripci√≥n'])
                            if orig != new
                        )
                        if improved_count > 0:
                            st.success(f"‚ú® {improved_count} descripciones mejoradas con nombres de contactos")

            except Exception as e:
                st.warning(f"‚ö†Ô∏è No se pudieron mejorar descripciones: {e}")
                df_display = df_parsed.copy()

        # [RESTO DE LA FUNCI√ìN PERMANECE IGUAL...]
        # M√©tricas principales
        col1, col2, col3, col4 = st.columns(4)

        with col1:
            st.metric("Total transacciones", len(df_parsed))

        with col2:
            gastos = df_parsed[df_parsed['Monto'] < 0] if 'Monto' in df_parsed.columns else pd.DataFrame()
            st.metric("Gastos (CARGO)", len(gastos))

        with col3:
            ingresos = df_parsed[df_parsed['Monto'] > 0] if 'Monto' in df_parsed.columns else pd.DataFrame()
            st.metric("Ingresos (ABONO)", len(ingresos))

        with col4:
            if 'Monto' in df_parsed.columns:
                balance = df_parsed['Monto'].sum()
                balance_fmt = f"${balance:,.0f}".replace(",",
                                                         ".") if balance >= 0 else f"-${abs(balance):,.0f}".replace(",",
                                                                                                                    ".")
                st.metric("Balance Neto", balance_fmt)

        # [RESTO DE LA FUNCI√ìN...]

    except Exception as e:
        st.error(f"‚ùå Error mostrando preview: {str(e)}")


# 3. ACTUALIZAR LA NAVEGACI√ìN PARA DESTACAR LAS NUEVAS CARACTER√çSTICAS
def sidebar_navigation():
    """Navegaci√≥n principal en sidebar mejorada"""
    st.sidebar.title("üß≠ Navegaci√≥n")

    pages = {
        "üìÅ Cargar Cartola": "upload",
        "üè∑Ô∏è Etiquetar Gastos": "labeling",
        "ü§ñ Entrenar IA": "training",
        "üìä Dashboard": "dashboard",
        "üë• Gesti√≥n Contactos üÜï": "contacts",  # üÜï DESTACAR NUEVAS CARACTER√çSTICAS
        "üîÑ Integraci√≥n KAME": "kame",
        "‚öôÔ∏è Configuraci√≥n": "settings"
    }

    selected_page = st.sidebar.radio("Seleccionar p√°gina:", list(pages.keys()))

    # MOSTRAR INFORMACI√ìN SOBRE LAS NUEVAS CARACTER√çSTICAS
    if pages[selected_page] == "contacts":
        st.sidebar.markdown("---")
        st.sidebar.markdown("### üÜï Nuevo Sistema de Contactos")
        st.sidebar.success("‚úÖ Detecci√≥n autom√°tica de res√∫menes")
        st.sidebar.success("‚úÖ Eliminaci√≥n inteligente de duplicados")
        st.sidebar.success("‚úÖ Consolidaci√≥n de m√∫ltiples transferencias")
        st.sidebar.info("üí° Sube un Excel del banco para probar")

    # [RESTO DE LA FUNCI√ìN PERMANECE IGUAL...]
    return pages[selected_page]


# 4. A√ëADIR FUNCI√ìN HELPER PARA MOSTRAR ESTADO DEL SISTEMA DE CONTACTOS
def show_contacts_system_status():
    """Muestra estado del sistema de contactos en el sidebar"""

    try:
        # Verificar sistema mejorado
        from contacts.transfer_summary_detector import ImprovedContactsManager
        from contacts.enhanced_contacts_interface import show_transfer_summary_page

        st.sidebar.success("üöÄ Sistema avanzado disponible")

        # Mostrar estad√≠sticas b√°sicas si hay datastore
        try:
            datastore, status = get_component('datastore')
            if status == ComponentStatus.READY:
                contacts = datastore.get_contacts()
                if contacts:
                    st.sidebar.info(f"üë• {len(contacts)} contactos registrados")
                else:
                    st.sidebar.info("üë• Sin contactos registrados")
        except:
            pass

    except ImportError:
        try:
            # Verificar sistema b√°sico
            from contacts.contacts_manager import show_contacts_management_page
            st.sidebar.warning("‚ö†Ô∏è Solo sistema b√°sico disponible")

        except ImportError:
            st.sidebar.error("‚ùå Sistema de contactos no disponible")


# 5. INTEGRAR EN LA FUNCI√ìN PRINCIPAL main()
def main():
    """Funci√≥n principal mejorada"""
    try:
        # Inicializar estado de la sesi√≥n
        initialize_session_state()

        # Header principal
        main_header()

        # Navegaci√≥n y contenido
        current_page = sidebar_navigation()

        # MOSTRAR ESTADO DEL SISTEMA DE CONTACTOS
        if current_page == "contacts":
            show_contacts_system_status()

        # Mostrar p√°gina seleccionada con manejo robusto
        try:
            if current_page == "upload":
                page_upload()
            elif current_page == "labeling":
                page_labeling()
            elif current_page == "training":
                page_training()
            elif current_page == "dashboard":
                page_dashboard()
            elif current_page == "contacts":  # P√ÅGINA MEJORADA
                page_contacts()
            elif current_page == "kame":
                page_kame()
            elif current_page == "settings":
                page_settings()

        except Exception as e:
            st.error(f"‚ùå Error en p√°gina {current_page}: {str(e)}")
            st.info("üîÑ Intenta recargar la p√°gina o reiniciar los componentes")

            with st.expander("üîç Detalles t√©cnicos"):
                st.code(traceback.format_exc())

    except Exception as e:
        st.error(f"‚ùå Error cr√≠tico de la aplicaci√≥n: {str(e)}")
        st.stop()

def page_kame():
    """P√°gina KAME simplificada"""
    st.header("üîÑ Integraci√≥n KAME")
    st.markdown("Concilia transacciones bancarias con documentos del ERP KAME.")
    st.info("üîß Funcionalidad en desarrollo")


def page_settings():
    """P√°gina de configuraci√≥n mejorada"""
    st.header("‚öôÔ∏è Configuraci√≥n")

    # Estado del sistema
    st.markdown("### üîß Estado del Sistema")

    from components.component_manager import get_component_manager
    manager = get_component_manager()
    system_status = manager.get_system_status()

    col1, col2, col3 = st.columns(3)

    with col1:
        st.metric("Componentes totales", system_status['total_components'])
    with col2:
        st.metric("Componentes listos", system_status['ready_components'])
    with col3:
        st.metric("Errores cr√≠ticos", system_status['critical_errors'])

    if st.button("üîÑ Reinicializar todo el sistema"):
        manager.initialize_all()
        st.success("‚úÖ Sistema reinicializado")
        st.rerun()

    # Gesti√≥n de categor√≠as (si DataStore est√° disponible)
    datastore, datastore_status = get_component('datastore')
    if datastore_status == ComponentStatus.READY:
        show_category_management(datastore)

    # Informaci√≥n del sistema
    st.markdown("---")
    st.markdown("### ‚ÑπÔ∏è Informaci√≥n del Sistema")

    col1, col2, col3 = st.columns(3)

    with col1:
        st.text("üìÅ Directorio datos: data/")

    with col2:
        st.text("ü§ñ Modelo: LogisticRegression")

    with col3:
        st.text("üìä Versi√≥n: 1.0.0")


def show_category_management(datastore):
    """Gesti√≥n de categor√≠as"""
    st.markdown("### üè∑Ô∏è Gesti√≥n de Categor√≠as")

    try:
        categories = datastore.get_categories()

        col1, col2 = st.columns(2)

        with col1:
            st.markdown("**Categor√≠as disponibles:**")
            for i, cat in enumerate(categories, 1):
                st.text(f"{i:2d}. {cat}")

        with col2:
            nueva_cat = st.text_input("Agregar nueva categor√≠a:")
            if st.button("‚ûï Agregar categor√≠a") and nueva_cat.strip():
                if datastore.add_category(nueva_cat.strip().lower()):
                    st.success(f"‚úÖ Categor√≠a '{nueva_cat}' agregada")
                    st.rerun()
                else:
                    st.error("‚ùå Error agregando categor√≠a o ya existe")

    except Exception as e:
        st.error(f"‚ùå Error gestionando categor√≠as: {str(e)}")


def main():
    """Funci√≥n principal mejorada"""
    try:
        # Inicializar estado de la sesi√≥n
        initialize_session_state()

        # Header principal
        main_header()

        # Navegaci√≥n y contenido
        current_page = sidebar_navigation()

        # Mostrar p√°gina seleccionada con manejo robusto
        try:
            if current_page == "upload":
                page_upload()
            elif current_page == "labeling":
                page_labeling()
            elif current_page == "training":
                page_training()
            elif current_page == "dashboard":
                page_dashboard()
            elif current_page == "contacts":  # üÜï NUEVA P√ÅGINA
                page_contacts()
            elif current_page == "kame":
                page_kame()
            elif current_page == "settings":
                page_settings()
        except Exception as e:
            st.error(f"‚ùå Error en p√°gina {current_page}: {str(e)}")
            st.info("üîÑ Intenta recargar la p√°gina o reiniciar los componentes")

            with st.expander("üîç Detalles t√©cnicos"):
                st.code(traceback.format_exc())

    except Exception as e:
        st.error(f"‚ùå Error cr√≠tico de la aplicaci√≥n: {str(e)}")
        st.stop()


if __name__ == "__main__":
    main()